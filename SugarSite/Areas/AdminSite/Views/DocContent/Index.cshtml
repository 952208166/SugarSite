
@{
    ViewBag.Title = "文档管理";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}
@section js{
    <script src="~/_theme/layui-v1.0.3/layui/lay/modules/jsGrid.js"></script>
    <script>
        layui.use(['tree', 'layer', 'jsGrid', 'ejq', 'laypage'], function () {
            var layer = layui.layer, $ = layui.jquery, jsGrid = layui.jsGrid; laypage = layui.laypage
            var $sizeDemo = $(".site-demo");
            var $gridTable = $(".gridtable");
            var $buttonBox = $(".site-demo-button");
            var btnAdd = $("#btnAdd");
            var btnAdd = $("#btnAdd");
            var btnDel = $("#btnDel");
            var btnSelect = $("#btnSelect");
            var hidTypeId = $("#hidTypeId");
            var hidTypeName = $("#hidTypeName");
            var lblTypeName = $("#lblTypeName");

            //创建grid
            var listGird = new jsGrid({
                id: "listGrid",
                width: "100%",
                doubleHead: true,
                height: $(window).height() - $buttonBox.height() - 150,
                "class": "gridtable",
                columns: [
               {
                   title: "标题",
                   indexname: "Title",
                   textalign: 'center',
                   width: "50",
                   formatter:
                   function (val, rowdata, rowindex, td, trL, trR) {
                       return '<input name="ids" value="' + rowdata.Id + '" type="checkbox" />';
                   }
               },
                {
                    title: "编号",
                    indexname: "Id",
                    textalign: 'left',
                    width: 100,
                },
                {
                    title: "标题",
                    indexname: "Title",
                    textalign: 'left',
                    width: 500,
                    formatter:
                    function (val, rowdata, rowindex, td, trL, trR) {
                        return '<a target="_blank" href="' + $.action.url("PageDCAdd", null, "DocContent", "AdminSite") + "?id=" + rowdata.Id + '&typeName=' + encodeURI(rowdata.TypeName) + '">' + val + '</a>';
                    }
                },
                {
                    title: "创建人",
                    indexname: "Creator",
                    textalign: 'center',
                    width: 100
                },
                {
                    title: "创建时间",
                    indexname: "CreateTime",
                    textalign: 'center',
                    width: 100
                }]
            })

            btnAdd.click(function () {
                var addUrl = layui.ejq.action.url("PageDCAdd", null, "DocContent", "AdminSite");
                if (hidTypeId.val() != "") {
                    addUrl += "?typeId=" + hidTypeId.val() + "&typeName=" +encodeURI(hidTypeName.val());
                    window.open(addUrl);
                } else {
                    layer.msg('请选择分类！');
                }
            })

            btnDel.click(function () {
                //询问框
                layer.confirm('您是否要删除？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    var ccb = $("input:checkbox:checked");
                    if (ccb.size() == 0) {
                        layer.msg('请选择一项！', { icon: 1 });
                        return;
                    }
                    $.ajax({
                        url: $.action.url("DC_Delete", null, "DocContent", "AdminSite"),
                        data: { ids: ccb.attrToArray("value") },
                        cache: false,
                        traditional: true,
                        success: function (msg) {
                            bindGird();
                            layer.msg('删除成功！', { icon: 1 });
                        },
                        error: function (msg) {
                            console.log(msg);
                            layer.msg('删除失败！', { icon: 1 });
                        }
                    })
                }, function () {

                });
            })

            btnSelect.click(function () {
                var cbs = $("input:checkbox");
                var isChecked = cbs.prop("checked");
                cbs.prop("checked", !isChecked)
            })

            bindGird();

            bindTree();


            function bindTree() {
                $.ajax({
                    url: $.action.url("Dc_GetTypeList", null, "DocContent", "AdminSite"),
                    cache: false,
                    success: function (msg) {
                        layui.tree({
                            elem: '#treediv',
                            target: '_blank',
                            click: function (item) { //点击节点回调
                                hidTypeId.val(item.id);
                                hidTypeName.val(item.name)
                                lblTypeName.html("<span>当前分类:</span>"+item.name);
                                bindGird();
                            }, nodes: msg.ResultInfo
                        });
                    }
                });
            }
            function bindGird(obj) {
                $.ajax({
                    url: $.action.url("Dc_GetList", null, "DocContent", "AdminSite"),
                    data: { pageIndex: obj == null ? 1 : obj.curr, typeId: hidTypeId.val() },
                    cache: false,
                    success: function (msg) {
                        var datas = msg.ResultInfo.DocList;
                        listGird.RenderTo('listdiv');
                        listGird.dataStore = datas;
                        listGird.ShowData();
                        laypage({
                            cont: 'pagediv'
                           , pages: msg.ResultInfo.Pages
                           , curr: msg.ResultInfo.PageIndex
                           , prev: '<em><</em>'
                           , next: '<em>></em>'
                           , jump: function (obj, first) {
                               if (!first) {
                                   bindGird(obj);
                               }
                           }
                        });
                    },
                    error: function (msg) {
                        console.log(msg);
                    }
                })
            }
        });
    </script>
}
<input type="hidden" id="hidTypeName" />
<input type="hidden" id="hidTypeId" />
<div style="display: inline-block; width: 180px; height:calc(100% - 26px); padding: 10px; border: 1px solid #ddd; overflow: auto; margin:0">
    <ul id="treediv"></ul>
</div>
<div style="display: inline-block; width: calc(100%-260px); height:calc(100% - 26px); padding: 10px; border: 0; overflow: auto; margin:0" class="gridtable">
    <fieldset class="layui-elem-field site-demo-button">
        <legend>操作</legend>
        <div>
            <table class="action-table" width="100%">
                <tr>
                    <td class="left">
                        <button id="btnSelect" class="layui-btn layui-btn-primary">全选/反选</button>
                        <label id="lblTypeName" class="type-name"></label>
                    </td>
                    <td class="right">
                        <button id="btnAdd" class="layui-btn">添加文档</button>
                        <button id="btnDel" class="layui-btn ">删除文档</button>
                        <button id="btnAddType" class="layui-btn layui-btn-warm">添加分类</button>
                        <button id="btnDelType" class="layui-btn layui-btn-warm">删除分类</button>
                        <button id="btnEditType" class="layui-btn layui-btn-warm">修改分类</button>
                    </td>
                </tr>
            </table>
        </div>
    </fieldset>
    <div id="listdiv"></div>
    <div id="pagediv"></div>
</div>